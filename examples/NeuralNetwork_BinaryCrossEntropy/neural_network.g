LoadPackage( "MachineLearningForCAP" );


Smooth := SkeletalSmoothMaps;
Lenses := CategoryOfLenses( Smooth );
Para := CategoryOfParametrisedMorphisms( Smooth );


## The function we are trying minimize
f := LossMorphismOfNeuralNetwork( Para, 2, [ 6, 6, 6 ], 1, "Sigmoid" );

## One epoch update of the parameters
optimizer := Lenses.GradientDescentOptimizer( : learning_rate := 0.01 );

training_examples_path := "data/training_examples.txt";

batch_size := 1;

one_epoch_update := OneEpochUpdateLens( f, optimizer, training_examples_path, batch_size );

## Initialize the parameters and apply updates nr_epochs times
#   Affine transformation 1:
#   [[-0.8253305  -0.5519657   0.5695067  -0.55729055  0.31805855  0.61735636]
#    [-0.35807824  0.5614671   0.22939318  0.35675365 -0.18503785  0.33399004]
#    [ 0.          0.          0.          0.          0.          0.        ]]
#
#   Affine transformation 2:
#   [[ 0.7025898   0.40877253  0.20995468 -0.44061258 -0.22173643 -0.13360518]
#    [ 0.07342285 -0.3142012   0.6646419  -0.41498005 -0.05349869  0.417332  ]
#    [ 0.55641776  0.18377596 -0.48378092 -0.21800154 -0.03115106  0.58989066]
#    [-0.6362306   0.62437385 -0.16361392 -0.5767567  -0.23374996  0.41223532]
#    [-0.51186776 -0.11312515  0.38304657  0.05555409  0.14883518  0.673979  ]
#    [ 0.5672495  -0.62053126  0.58642703  0.463453   -0.16229266  0.61534077]
#    [ 0.          0.          0.          0.          0.          0.        ]]
#
#   Affine transformation 3:
#   [[ 0.6278847   0.30747253  0.6831216  -0.00804061  0.2587368   0.58708113]
#    [ 0.25971985 -0.56481445 -0.05164099  0.5079209  -0.2920736  -0.44521216]
#    [ 0.6427106  -0.3777305   0.51464826  0.60129505  0.22585636 -0.4216755 ]
#    [ 0.37545222 -0.5169188   0.01861829  0.60314924  0.11511129  0.61970514]
#    [-0.33681872  0.6038982   0.16922754  0.01404923  0.6107089   0.12995255]
#    [-0.41838637 -0.00476396 -0.13253736  0.3037265  -0.5459578   0.13572395]
#    [ 0.          0.          0.          0.          0.          0.        ]]
#
#   Affine transformation 4:
#   [[ 0.5750419 ]
#    [-0.05423206]
#    [-0.7180484 ]
#    [ 0.41225922]
#    [ 0.43444705]
#    [ 0.6085528 ]
#    [ 0.        ]]

# Initial weights as vector:
w :=[ 0.5750418901443481, -0.05423206090927124, -0.7180483937263489, 0.41225922107696533, 0.4344470500946045, 0.6085528135299683, 0.0, 0.6278846859931946, 0.2597198486328125, 0.6427106261253357, 0.3754522204399109, -0.33681872487068176, -0.4183863699436188, 0.0, 0.3074725270271301, -0.5648144483566284, -0.37773048877716064, -0.5169187784194946, 0.6038982272148132, -0.004763960838317871, 0.0, 0.6831216216087341, -0.051640987396240234, 0.5146482586860657, 0.018618285655975342, 0.16922754049301147, -0.1325373649597168, 0.0, -0.00804060697555542, 0.5079209208488464, 0.6012950539588928, 0.6031492352485657, 0.014049232006072998, 0.3037264943122864, 0.0, 0.258736789226532, -0.2920736074447632, 0.22585636377334595, 0.11511129140853882, 0.6107088923454285, -0.5459578037261963, 0.0, 0.5870811343193054, -0.44521215558052063, -0.42167550325393677, 0.6197051405906677, 0.1299525499343872, 0.13572394847869873, 0.0, 0.7025898098945618, 0.07342284917831421, 0.5564177632331848, -0.6362305879592896, -0.5118677616119385, 0.5672494769096375, 0.0, 0.4087725281715393, -0.3142012059688568, 0.18377596139907837, 0.6243738532066345, -0.11312514543533325, -0.6205312609672546, 0.0, 0.20995467901229858, 0.6646419167518616, -0.4837809205055237, -0.1636139154434204, 0.38304656744003296, 0.5864270329475403, 0.0, -0.4406125843524933, -0.41498005390167236, -0.21800154447555542, -0.5767567157745361, 0.055554091930389404, 0.4634529948234558, 0.0, -0.22173643112182617, -0.053498685359954834, -0.03115105628967285, -0.23374995589256287, 0.1488351821899414, -0.16229265928268433, 0.0, -0.13360518217086792, 0.4173319935798645, 0.5898906588554382, 0.4122353196144104, 0.6739789843559265, 0.6153407692909241, 0.0, -0.8253304958343506, -0.3580782413482666, 0.0, -0.5519657135009766, 0.5614671111106873, 0.0, 0.5695067048072815, 0.22939318418502808, 0.0, -0.5572905540466309, 0.3567536473274231, 0.0, 0.3180585503578186, -0.18503785133361816, 0.0, 0.6173563599586487, 0.33399003744125366, 0.0 ];

nr_epochs := 25;

w := Fit( one_epoch_update, nr_epochs, w );

# After 10 epochs
